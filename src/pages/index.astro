---
import BaseLayout from '../layouts/BaseLayout.astro';
import PostCard from '../components/PostCard.astro';
import { getCollection } from 'astro:content';

// Get the base path from the config
const base = import.meta.env.BASE_URL;

// Get latest news posts
const allPosts = await getCollection('news');
const sortedPosts = allPosts.sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());
const recentPosts = sortedPosts.slice(0, 3);

// Import matches data
const matchesData = await import('../../data/matches.json');
const matches = matchesData.default.matches;

// Calculate goal scorers statistics
const goalScorers = new Map();
let totalGoals = 0;
matches.forEach(match => {
  if (match.scorers && match.scorers.length > 0) {
    match.scorers.forEach(scorer => {
      // Handle both string format ("Player Name") and object format ({player: "Name", goals: N})
      if (typeof scorer === 'string') {
        const cleanName = scorer.replace(/\s*\(.*?\)\s*/g, '').trim();
        goalScorers.set(cleanName, (goalScorers.get(cleanName) || 0) + 1);
        totalGoals += 1;
      } else if (scorer.player) {
        const goals = scorer.goals || 1;
        goalScorers.set(scorer.player, (goalScorers.get(scorer.player) || 0) + goals);
        totalGoals += goals;
      }
    });
  }
});

// Sort by goals (descending)
const sortedScorers = Array.from(goalScorers.entries())
  .sort((a, b) => b[1] - a[1])
  .slice(0, 10); // Top 10 scorers

// Calculate team stats
const totalMatches = matches.filter(m => m.result && m.result !== 'pending' && m.result !== 'cancelled').length;
const wins = matches.filter(m => m.result && m.result.includes('win')).length;
const losses = matches.filter(m => m.result && m.result.includes('loss')).length;
const draws = matches.filter(m => m.result && m.result.includes('draw')).length;

// Calculate goalkeeper appearances
const goalkeeperStats = new Map();
matches.forEach(match => {
  if (match.goalkeepers) {
    if (match.goalkeepers.first_half && match.goalkeepers.first_half !== 'TBD') {
      goalkeeperStats.set(match.goalkeepers.first_half, (goalkeeperStats.get(match.goalkeepers.first_half) || 0) + 1);
    }
    if (match.goalkeepers.second_half && match.goalkeepers.second_half !== 'TBD') {
      goalkeeperStats.set(match.goalkeepers.second_half, (goalkeeperStats.get(match.goalkeepers.second_half) || 0) + 1);
    }
  }
});

// Sort by appearances (descending)
const sortedGoalkeepers = Array.from(goalkeeperStats.entries())
  .sort((a, b) => b[1] - a[1]);

// Calculate clean sheet halves - each goalkeeper plays one half, credit them if no goals conceded in their half
const cleanSheetHalves = new Map();
matches.forEach(match => {
  if (!match.goalkeepers || match.result === 'cancelled' || match.result === 'pending') return;

  // Parse half-time score to determine goals conceded per half
  // Format: "X-Y" where X is QPR goals, Y is opponent goals at half-time
  // Or "X-Y QPR" format
  let firstHalfConceded = null;
  let secondHalfConceded = null;

  if (match.final_score && match.final_score.half_time && match.final_score.half_time !== 'TBD') {
    const halfTime = match.final_score.half_time.replace(' QPR', '');
    const htParts = halfTime.split('-').map(s => parseInt(s.trim()));
    const totalConceded = match.final_score.opponent || 0;

    if (htParts.length === 2 && !isNaN(htParts[0]) && !isNaN(htParts[1])) {
      // htParts[1] is opponent goals at half-time (goals conceded in 1st half)
      firstHalfConceded = htParts[1];
      secondHalfConceded = totalConceded - htParts[1];
    }
  }

  // Credit clean sheet halves
  if (firstHalfConceded === 0 && match.goalkeepers.first_half && match.goalkeepers.first_half !== 'TBD') {
    cleanSheetHalves.set(match.goalkeepers.first_half, (cleanSheetHalves.get(match.goalkeepers.first_half) || 0) + 1);
  }
  if (secondHalfConceded === 0 && match.goalkeepers.second_half && match.goalkeepers.second_half !== 'TBD') {
    cleanSheetHalves.set(match.goalkeepers.second_half, (cleanSheetHalves.get(match.goalkeepers.second_half) || 0) + 1);
  }
});

// Sort clean sheet halves by count
const sortedCleanSheetKeepers = Array.from(cleanSheetHalves.entries())
  .sort((a, b) => b[1] - a[1]);
---

<BaseLayout title="Home - Queens Park Rangers U11B">
  <!-- Hero Section -->
  <section class="hero field-pattern">
    <div class="container">
      <h1 class="soccer-bounce">‚öΩ Queens Park Rangers ‚öΩ</h1>
      <p><strong>U11 Boys ‚Ä¢ Coquitlam Metro-Ford SC ‚Ä¢ Season 2025-2026</strong></p>
      <p>Building momentum with {wins} {wins === 1 ? 'win' : 'wins'} this season! üèÜ</p>
    </div>
  </section>

  <div class="container">
    <!-- Season Dashboard -->
    <section style="margin-top: var(--spacing-2xl);">
      <h2>üìä Season Dashboard</h2>
      <div class="grid grid-4">
        <div class="card stat-card">
          <div class="stat-number">{totalMatches}</div>
          <div class="stat-label">Matches Played</div>
        </div>
        <div class="card stat-card stat-wins">
          <div class="stat-number">{wins}</div>
          <div class="stat-label">Wins</div>
        </div>
        <div class="card stat-card stat-draws">
          <div class="stat-number">{draws}</div>
          <div class="stat-label">Draws</div>
        </div>
        <div class="card stat-card stat-losses">
          <div class="stat-number">{losses}</div>
          <div class="stat-label">Losses</div>
        </div>
      </div>
      <div class="grid grid-2" style="margin-top: var(--spacing-md);">
        <div class="card stat-card stat-goals">
          <div class="stat-number">{totalGoals}</div>
          <div class="stat-label">Goals Scored</div>
        </div>
        <div class="card stat-card stat-goals-avg">
          <div class="stat-number">{totalMatches > 0 ? (totalGoals / totalMatches).toFixed(1) : 0}</div>
          <div class="stat-label">Goals per Match</div>
        </div>
      </div>
    </section>

    <!-- Top Scorers Section -->
    {sortedScorers.length > 0 && (
      <section style="margin-top: var(--spacing-2xl);">
        <h2>‚öΩ Top Goal Scorers</h2>
        <div class="card">
          <div class="scorers-table">
            {sortedScorers.map((scorer, index) => (
              <div class="scorer-row">
                <div class="scorer-rank">{index + 1}</div>
                <div class="scorer-name">{scorer[0]}</div>
                <div class="scorer-goals">
                  <span class="goals-number">{scorer[1]}</span>
                  <span class="goals-label">{scorer[1] === 1 ? 'goal' : 'goals'}</span>
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- Goalkeeper Stats Section -->
    {sortedGoalkeepers.length > 0 && (
      <section style="margin-top: var(--spacing-2xl);">
        <h2>üß§ Goalkeeper Rotation</h2>
        <div class="card">
          <div class="gk-table">
            {sortedGoalkeepers.map((gk, index) => (
              <div class="gk-row">
                <div class="gk-rank">{index + 1}</div>
                <div class="gk-name">{gk[0]}</div>
                <div class="gk-appearances">
                  <span class="appearances-number">{gk[1]}</span>
                  <span class="appearances-label">{gk[1] === 1 ? 'half' : 'halves'}</span>
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- Clean Sheet Honor Roll -->
    {sortedCleanSheetKeepers.length > 0 && (
      <section style="margin-top: var(--spacing-2xl);">
        <h2>üõ°Ô∏è Clean Sheet Halves</h2>
        <p style="color: var(--gray-600); margin-bottom: var(--spacing-md);">Goalkeepers who kept clean sheet halves (0 goals conceded in their half)</p>
        <div class="card">
          <div class="cleansheet-table">
            {sortedCleanSheetKeepers.map((keeper, index) => (
              <div class="cleansheet-row">
                <div class="cleansheet-rank">{index + 1}</div>
                <div class="cleansheet-name">{keeper[0]}</div>
                <div class="cleansheet-count">
                  <span class="cleansheet-number">{keeper[1]}</span>
                  <span class="cleansheet-label">{keeper[1] === 1 ? 'half' : 'halves'}</span>
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- Latest News Section -->
    <section style="margin-top: var(--spacing-2xl);">
      <h2>üì∞ Latest News</h2>
      <div class="grid grid-3">
        {recentPosts.map(post => (
          <PostCard 
            title={post.data.title}
            date={post.data.date}
            summary={post.data.summary}
            slug={post.slug}
            tags={post.data.tags}
          />
        ))}
      </div>
      <div style="text-align: center; margin-top: var(--spacing-lg);">
        <a href={`${base}news/`} class="btn">View All News ‚Üí</a>
      </div>
    </section>

    <!-- Quick Links -->
    <section style="margin-top: var(--spacing-2xl);">
      <h2>üîó Quick Links</h2>
      <div class="grid grid-3">
        <a href={`${base}current-week/`} class="card game-card" style="text-decoration: none; color: inherit;">
          <h3>üìÖ This Week</h3>
          <p>Training schedule, lineup, and next match</p>
        </a>
        
        <a href={`${base}matches/`} class="card game-card" style="text-decoration: none; color: inherit;">
          <h3>üèüÔ∏è Match Center</h3>
          <p>View games, scores, and highlights</p>
        </a>
        
        <a href={`${base}roster/`} class="card game-card" style="text-decoration: none; color: inherit;">
          <h3>üë• Team Roster</h3>
          <p>Meet the QPR U11B squad</p>
        </a>
      </div>
    </section>
  </div>

  <style>
    .grid-4 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--spacing-md);
    }

    .stat-card {
      text-align: center;
      padding: var(--spacing-lg);
      background: linear-gradient(135deg, var(--qpr-blue) 0%, #1e4d8b 100%);
      color: white;
      border: none;
    }

    .stat-wins {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    }

    .stat-draws {
      background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
    }

    .stat-losses {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }

    .stat-goals {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    }

    .stat-goals-avg {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    }

    .stat-number {
      font-size: 3rem;
      font-weight: bold;
      line-height: 1;
      margin-bottom: var(--spacing-sm);
    }

    .stat-label {
      font-size: 0.9rem;
      opacity: 0.9;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .scorers-table {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .scorer-row {
      display: grid;
      grid-template-columns: 40px 1fr auto;
      align-items: center;
      padding: var(--spacing-sm) var(--spacing-md);
      background: var(--gray-50);
      border-radius: var(--border-radius);
      transition: all 0.2s;
    }

    .scorer-row:hover {
      background: var(--gray-100);
      transform: translateX(5px);
    }

    .scorer-row:first-child {
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
    }

    .scorer-row:nth-child(2) {
      background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
      font-weight: bold;
    }

    .scorer-row:nth-child(3) {
      background: linear-gradient(135deg, #cd7f32 0%, #e5a572 100%);
      font-weight: bold;
    }

    .scorer-rank {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--qpr-blue);
      text-align: center;
    }

    .scorer-row:first-child .scorer-rank,
    .scorer-row:nth-child(2) .scorer-rank,
    .scorer-row:nth-child(3) .scorer-rank {
      color: #333;
    }

    .scorer-name {
      font-size: 1rem;
    }

    .scorer-goals {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .goals-number {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--qpr-blue);
    }

    .scorer-row:first-child .goals-number,
    .scorer-row:nth-child(2) .goals-number,
    .scorer-row:nth-child(3) .goals-number {
      color: #333;
    }

    .goals-label {
      font-size: 0.8rem;
      color: var(--gray-600);
    }

    .gk-table {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .gk-row {
      display: grid;
      grid-template-columns: 40px 1fr auto;
      align-items: center;
      padding: var(--spacing-sm) var(--spacing-md);
      background: var(--gray-50);
      border-radius: var(--border-radius);
      transition: all 0.2s;
    }

    .gk-row:hover {
      background: var(--gray-100);
      transform: translateX(5px);
    }

    .gk-row:first-child {
      background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
      color: white;
      font-weight: bold;
    }

    .gk-row:nth-child(2) {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      font-weight: bold;
    }

    .gk-row:nth-child(3) {
      background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
      color: white;
      font-weight: bold;
    }

    .gk-rank {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--qpr-blue);
      text-align: center;
    }

    .gk-row:first-child .gk-rank,
    .gk-row:nth-child(2) .gk-rank,
    .gk-row:nth-child(3) .gk-rank {
      color: white;
    }

    .gk-name {
      font-size: 1rem;
    }

    .gk-appearances {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .appearances-number {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--qpr-blue);
    }

    .gk-row:first-child .appearances-number,
    .gk-row:nth-child(2) .appearances-number,
    .gk-row:nth-child(3) .appearances-number {
      color: white;
    }

    .appearances-label {
      font-size: 0.8rem;
      color: var(--gray-600);
    }

    .gk-row:first-child .appearances-label,
    .gk-row:nth-child(2) .appearances-label,
    .gk-row:nth-child(3) .appearances-label {
      color: rgba(255, 255, 255, 0.8);
    }

    .cleansheet-table {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .cleansheet-row {
      display: grid;
      grid-template-columns: 40px 1fr auto;
      align-items: center;
      padding: var(--spacing-sm) var(--spacing-md);
      background: var(--gray-50);
      border-radius: var(--border-radius);
      transition: all 0.2s;
    }

    .cleansheet-row:hover {
      background: var(--gray-100);
      transform: translateX(5px);
    }

    .cleansheet-row:first-child {
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
    }

    .cleansheet-row:nth-child(2) {
      background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
      font-weight: bold;
    }

    .cleansheet-row:nth-child(3) {
      background: linear-gradient(135deg, #cd7f32 0%, #e5a572 100%);
      font-weight: bold;
    }

    .cleansheet-rank {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--qpr-blue);
      text-align: center;
    }

    .cleansheet-row:first-child .cleansheet-rank,
    .cleansheet-row:nth-child(2) .cleansheet-rank,
    .cleansheet-row:nth-child(3) .cleansheet-rank {
      color: #333;
    }

    .cleansheet-name {
      font-size: 1rem;
    }

    .cleansheet-count {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .cleansheet-number {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--qpr-blue);
    }

    .cleansheet-row:first-child .cleansheet-number,
    .cleansheet-row:nth-child(2) .cleansheet-number,
    .cleansheet-row:nth-child(3) .cleansheet-number {
      color: #333;
    }

    .cleansheet-label {
      font-size: 0.8rem;
      color: var(--gray-600);
    }

    @media (max-width: 768px) {
      .grid-4 {
        grid-template-columns: repeat(2, 1fr);
      }

      .stat-number {
        font-size: 2rem;
      }

      .scorer-row {
        grid-template-columns: 30px 1fr auto;
        padding: var(--spacing-xs) var(--spacing-sm);
      }

      .scorer-rank {
        font-size: 1rem;
      }

      .scorer-name {
        font-size: 0.9rem;
      }

      .goals-number {
        font-size: 1.2rem;
      }

      .gk-row {
        grid-template-columns: 30px 1fr auto;
        padding: var(--spacing-xs) var(--spacing-sm);
      }

      .gk-rank {
        font-size: 1rem;
      }

      .gk-name {
        font-size: 0.9rem;
      }

      .appearances-number {
        font-size: 1.2rem;
      }

      .cleansheet-row {
        grid-template-columns: 30px 1fr auto;
        padding: var(--spacing-xs) var(--spacing-sm);
      }

      .cleansheet-rank {
        font-size: 1rem;
      }

      .cleansheet-name {
        font-size: 0.9rem;
      }

      .cleansheet-number {
        font-size: 1.2rem;
      }
    }
  </style>
</BaseLayout>
