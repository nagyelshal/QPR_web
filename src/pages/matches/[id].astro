---
import BaseLayout from '../../layouts/BaseLayout.astro';
import matchesData from '../../../data/matches.json';
import seasonSchedule from '../../../data/season-schedule.json';

export async function getStaticPaths() {
  return matchesData.matches.map(match => ({
    params: { id: match.id },
    props: { match }
  }));
}

const { match } = Astro.props;
const title = `Match vs ${match.opponent}`;
const description = `Match details for QPR U11B vs ${match.opponent}`;

const base = import.meta.env.BASE_URL;

// Get venue info
function getVenueInfo(match) {
  const scheduleMatch = seasonSchedule.matches.find(m => m.match_number === match.match_number);
  if (scheduleMatch) {
    const isQPRHome = scheduleMatch.home_team.includes('Queens Park Rangers') || scheduleMatch.home_team.includes('QPR');
    return { isHome: isQPRHome, text: isQPRHome ? 'Home' : 'Away', class: isQPRHome ? 'home' : 'away' };
  }
  const isHome = match.location?.toLowerCase().includes('home') || match.venue_type === 'home';
  return { isHome, text: isHome ? 'Home' : 'Away', class: isHome ? 'home' : 'away' };
}

const venueInfo = getVenueInfo(match);
const isPending = match.result === 'pending';
const isCancelled = match.result === 'cancelled';
const isCompleted = !isPending && !isCancelled;

// Determine result
let resultClass = '';
let resultText = '';
if (isCompleted) {
  const qprScore = match.final_score?.qpr ?? 0;
  const oppScore = match.final_score?.opponent ?? 0;
  if (qprScore > oppScore) {
    resultClass = 'win';
    resultText = 'Victory';
  } else if (qprScore < oppScore) {
    resultClass = 'loss';
    resultText = 'Defeat';
  } else {
    resultClass = 'draw';
    resultText = 'Draw';
  }
}

// Format scorers for display
function formatScorers(scorers) {
  if (!scorers || scorers.length === 0) return [];
  return scorers.map(s => {
    if (typeof s === 'object' && s.player) {
      return { name: s.player, goals: s.goals || 1, time: s.time };
    }
    // Handle "Player (2)" format
    const match = String(s).match(/^(.+?)\s*\((\d+)\)$/);
    if (match) {
      return { name: match[1].trim(), goals: parseInt(match[2]) };
    }
    return { name: String(s), goals: 1 };
  });
}

// Format assists for display
function formatAssists(assists) {
  if (!assists || assists.length === 0) return [];
  return assists.map(a => {
    if (typeof a === 'object' && a.player) {
      return { name: a.player, assists: a.assists || 1 };
    }
    return { name: String(a), assists: 1 };
  });
}

const scorers = formatScorers(match.scorers);
const assists = formatAssists(match.assists);
---

<BaseLayout title={title} description={description}>
  <div class="match-detail">
    <!-- Back Link -->
    <a href={`${base}matches/`} class="back-link">‚Üê Back to Matches</a>

    <!-- Match Header -->
    <header class="match-header">
      <div class="match-meta">
        <span class="match-date">
          {new Date(match.date).toLocaleDateString('en-US', {
            weekday: 'short',
            month: 'short',
            day: 'numeric',
            year: 'numeric'
          })}
        </span>
        <span class={`venue-badge ${venueInfo.class}`}>{venueInfo.text}</span>
        <span class="week-badge">Week {match.week}</span>
      </div>

      <!-- Score Display -->
      <div class={`score-section ${isPending ? 'pending' : isCancelled ? 'cancelled' : resultClass}`}>
        <div class="team team-qpr">
          <span class="team-name">QPR</span>
          <span class="team-score">
            {isPending ? '-' : isCancelled ? 'X' : match.final_score?.qpr ?? '-'}
          </span>
        </div>
        <div class="score-divider">
          {isCompleted && (
            <span class={`result-badge ${resultClass}`}>{resultText}</span>
          )}
          {isPending && <span class="status-text">vs</span>}
          {isCancelled && <span class="status-text cancelled">Cancelled</span>}
        </div>
        <div class="team team-opp">
          <span class="team-score">
            {isPending ? '-' : isCancelled ? 'X' : match.final_score?.opponent ?? '-'}
          </span>
          <span class="team-name">{match.opponent}</span>
        </div>
      </div>

      {isCompleted && match.final_score?.half_time && (
        <div class="half-time">HT: {match.final_score.half_time}</div>
      )}

      {isCancelled && match.reason && (
        <div class="cancel-reason">{match.reason}</div>
      )}
    </header>

    <!-- Match Info -->
    <section class="info-section">
      <div class="info-row">
        <span class="info-label">Kickoff</span>
        <span class="info-value">{match.kickoff}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Location</span>
        <span class="info-value">{match.location}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Match #</span>
        <span class="info-value">{match.match_number}</span>
      </div>
      {match.formation && (
        <div class="info-row">
          <span class="info-label">Formation</span>
          <span class="info-value">{match.formation}</span>
        </div>
      )}
    </section>

    {isCompleted && (
      <>
        <!-- Scorers & Assists -->
        {(scorers.length > 0 || assists.length > 0) && (
          <section class="events-section">
            <h2>Match Events</h2>
            {scorers.length > 0 && (
              <div class="event-group">
                <h3>Goals</h3>
                <div class="event-list">
                  {scorers.map(s => (
                    <div class="event-item goal">
                      <span class="event-icon">‚öΩ</span>
                      <span class="event-player">{s.name}</span>
                      {s.goals > 1 && <span class="event-count">x{s.goals}</span>}
                      {s.time && <span class="event-time">{s.time}</span>}
                    </div>
                  ))}
                </div>
              </div>
            )}
            {assists.length > 0 && (
              <div class="event-group">
                <h3>Assists</h3>
                <div class="event-list">
                  {assists.map(a => (
                    <div class="event-item assist">
                      <span class="event-icon">üéØ</span>
                      <span class="event-player">{a.name}</span>
                      {a.assists > 1 && <span class="event-count">x{a.assists}</span>}
                    </div>
                  ))}
                </div>
              </div>
            )}
          </section>
        )}

        <!-- Goalkeepers -->
        {match.goalkeepers && (
          <section class="gk-section">
            <h2>Goalkeepers</h2>
            <div class="gk-grid">
              <div class="gk-card">
                <span class="gk-half">1st Half</span>
                <span class="gk-name">{match.goalkeepers.first_half}</span>
              </div>
              <div class="gk-card">
                <span class="gk-half">2nd Half</span>
                <span class="gk-name">{match.goalkeepers.second_half}</span>
              </div>
            </div>
          </section>
        )}

        <!-- Captains -->
        {match.captains && (
          <section class="captains-section">
            <h2>Captains</h2>
            <div class="captains-grid">
              <div class="captain-card">
                <span class="captain-half">1st Half</span>
                <span class="captain-name">{match.captains.first_half}</span>
              </div>
              <div class="captain-card">
                <span class="captain-half">2nd Half</span>
                <span class="captain-name">{match.captains.second_half}</span>
              </div>
            </div>
          </section>
        )}

        <!-- Highlights -->
        {match.highlights && match.highlights.length > 0 && (
          <section class="highlights-section">
            <h2>Match Highlights</h2>
            <ul class="highlights-list">
              {match.highlights.map(h => (
                <li>{h}</li>
              ))}
            </ul>
          </section>
        )}

        <!-- Lineup -->
        {match.starting_lineup && match.starting_lineup.length > 0 && (
          <section class="lineup-section">
            <h2>Starting Lineup</h2>
            <div class="lineup-grid">
              {match.starting_lineup.map(player => (
                <div class="player-chip">
                  <span class="player-number">#{player.jersey}</span>
                  <span class="player-name">{player.name}</span>
                  <span class="player-pos">{player.pos}</span>
                </div>
              ))}
            </div>
          </section>
        )}

        <!-- Achievements -->
        {match.achievements && match.achievements.length > 0 && (
          <section class="achievements-section">
            <h2>Achievements</h2>
            <div class="achievements-list">
              {match.achievements.map(a => (
                <div class="achievement-badge">
                  <span class="achievement-icon">üèÜ</span>
                  <span>{a}</span>
                </div>
              ))}
            </div>
          </section>
        )}
      </>
    )}

    {isPending && (
      <section class="upcoming-section">
        <div class="upcoming-message">
          <span class="upcoming-icon">‚è≥</span>
          <h3>Upcoming Match</h3>
          <p>Match details will be updated after the game</p>
        </div>
      </section>
    )}
  </div>
</BaseLayout>

<style>
  .match-detail {
    max-width: 600px;
    margin: 0 auto;
    padding: var(--spacing-md);
  }

  .back-link {
    display: inline-block;
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 600;
    font-size: 0.85rem;
    margin-bottom: var(--spacing-md);
  }

  .back-link:hover {
    text-decoration: underline;
  }

  /* Match Header */
  .match-header {
    background: white;
    border-radius: 16px;
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-md);
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
    text-align: center;
  }

  .match-meta {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-md);
    flex-wrap: wrap;
  }

  .match-date {
    font-size: 0.85rem;
    color: var(--color-text-light);
  }

  .venue-badge {
    font-size: 0.7rem;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 10px;
    text-transform: uppercase;
  }

  .venue-badge.home {
    background: #d4edda;
    color: #155724;
  }

  .venue-badge.away {
    background: #cce5ff;
    color: #004085;
  }

  .week-badge {
    font-size: 0.7rem;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 10px;
    background: var(--color-primary);
    color: white;
  }

  /* Score Section */
  .score-section {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
  }

  .team {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 80px;
  }

  .team-qpr {
    text-align: right;
  }

  .team-opp {
    text-align: left;
  }

  .team-name {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: 4px;
  }

  .team-score {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--color-primary);
    line-height: 1;
  }

  .score-section.win .team-qpr .team-score { color: #2ecc71; }
  .score-section.loss .team-qpr .team-score { color: #e74c3c; }
  .score-section.draw .team-qpr .team-score { color: #9b59b6; }

  .score-divider {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }

  .result-badge {
    font-size: 0.7rem;
    font-weight: 700;
    padding: 4px 10px;
    border-radius: 12px;
    text-transform: uppercase;
  }

  .result-badge.win { background: #d4edda; color: #155724; }
  .result-badge.loss { background: #f8d7da; color: #721c24; }
  .result-badge.draw { background: #e8daef; color: #6c3483; }

  .status-text {
    font-size: 0.9rem;
    color: var(--color-text-light);
  }

  .status-text.cancelled {
    color: #dc3545;
    font-weight: 600;
  }

  .half-time {
    font-size: 0.8rem;
    color: var(--color-text-light);
    margin-top: var(--spacing-sm);
  }

  .cancel-reason {
    font-size: 0.85rem;
    color: #dc3545;
    margin-top: var(--spacing-sm);
    font-style: italic;
  }

  /* Info Section */
  .info-section {
    background: white;
    border-radius: 12px;
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  }

  .info-row {
    display: flex;
    justify-content: space-between;
    padding: var(--spacing-xs) 0;
    border-bottom: 1px solid #f0f0f0;
  }

  .info-row:last-child {
    border-bottom: none;
  }

  .info-label {
    font-size: 0.85rem;
    color: var(--color-text-light);
  }

  .info-value {
    font-size: 0.85rem;
    font-weight: 600;
  }

  /* Section Styles */
  section h2 {
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--color-text);
    margin-bottom: var(--spacing-sm);
  }

  /* Events Section */
  .events-section {
    background: white;
    border-radius: 12px;
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  }

  .event-group {
    margin-bottom: var(--spacing-md);
  }

  .event-group:last-child {
    margin-bottom: 0;
  }

  .event-group h3 {
    font-size: 0.8rem;
    color: var(--color-text-light);
    margin-bottom: var(--spacing-xs);
    text-transform: uppercase;
  }

  .event-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .event-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-xs) var(--spacing-sm);
    background: #f8f9fa;
    border-radius: 8px;
  }

  .event-item.goal {
    background: #e8f5e9;
    border-left: 3px solid #2ecc71;
  }

  .event-item.assist {
    background: #e3f2fd;
    border-left: 3px solid #1976d2;
  }

  .event-icon {
    font-size: 1rem;
  }

  .event-player {
    font-weight: 600;
    font-size: 0.9rem;
    flex: 1;
  }

  .event-count {
    font-weight: 700;
    font-size: 0.8rem;
    color: var(--color-primary);
    background: white;
    padding: 2px 6px;
    border-radius: 8px;
  }

  .event-time {
    font-size: 0.75rem;
    color: var(--color-text-light);
  }

  /* GK & Captains */
  .gk-section,
  .captains-section {
    background: white;
    border-radius: 12px;
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  }

  .gk-grid,
  .captains-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-sm);
  }

  .gk-card,
  .captain-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: var(--spacing-sm);
    text-align: center;
  }

  .gk-half,
  .captain-half {
    display: block;
    font-size: 0.7rem;
    color: var(--color-text-light);
    text-transform: uppercase;
    margin-bottom: 2px;
  }

  .gk-name,
  .captain-name {
    font-weight: 600;
    font-size: 0.9rem;
  }

  /* Highlights */
  .highlights-section {
    background: white;
    border-radius: 12px;
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  }

  .highlights-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .highlights-list li {
    padding: var(--spacing-xs) 0;
    padding-left: var(--spacing-md);
    position: relative;
    font-size: 0.85rem;
    border-bottom: 1px solid #f0f0f0;
  }

  .highlights-list li:last-child {
    border-bottom: none;
  }

  .highlights-list li::before {
    content: '‚Ä¢';
    position: absolute;
    left: 0;
    color: var(--color-primary);
    font-weight: bold;
  }

  /* Lineup */
  .lineup-section {
    background: white;
    border-radius: 12px;
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  }

  .lineup-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .player-chip {
    display: flex;
    align-items: center;
    gap: 6px;
    background: #f8f9fa;
    border-radius: 20px;
    padding: 4px 10px;
    font-size: 0.8rem;
  }

  .player-number {
    font-weight: 700;
    color: var(--color-primary);
  }

  .player-name {
    font-weight: 600;
  }

  .player-pos {
    color: var(--color-text-light);
    font-size: 0.7rem;
  }

  /* Achievements */
  .achievements-section {
    background: white;
    border-radius: 12px;
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  }

  .achievements-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .achievement-badge {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
    padding: var(--spacing-sm);
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    color: #e65100;
  }

  .achievement-icon {
    font-size: 1rem;
  }

  /* Upcoming */
  .upcoming-section {
    margin-bottom: var(--spacing-md);
  }

  .upcoming-message {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border-radius: 12px;
    padding: var(--spacing-xl);
    text-align: center;
  }

  .upcoming-icon {
    font-size: 2rem;
    display: block;
    margin-bottom: var(--spacing-sm);
  }

  .upcoming-message h3 {
    font-size: 1rem;
    margin-bottom: var(--spacing-xs);
    color: var(--color-primary);
  }

  .upcoming-message p {
    font-size: 0.85rem;
    color: var(--color-text-light);
    margin: 0;
  }

  /* Mobile */
  @media (max-width: 480px) {
    .match-detail {
      padding: var(--spacing-sm);
    }

    .match-header {
      padding: var(--spacing-md);
    }

    .team-score {
      font-size: 2rem;
    }

    .team-name {
      font-size: 0.75rem;
    }

    .score-section {
      gap: var(--spacing-sm);
    }

    .team {
      min-width: 60px;
    }

    .info-section,
    .events-section,
    .gk-section,
    .captains-section,
    .highlights-section,
    .lineup-section,
    .achievements-section {
      padding: var(--spacing-sm);
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .back-link:hover {
      text-decoration: underline;
    }
  }
</style>
